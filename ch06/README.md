# `Prototype`パターン
# 概要
`Prototype`パターンとは, クラスからインスタンスを生成するのではなく, インスタンスから別のインスタンスを作り出すパターンのことである.

原型となるインスタンス, 模範となるインスタンスを元に新しいインスタンスを作るのである.

コピー機を使って書類をコピーするイメージと考えると良いだろう(元の書類をどうやって作ったかを知らなくても, コピー機にかければ同じ書類を何枚でも作れる)

> prototype: 原型, 模範

インスタンスから別のインスタンスを生成したくなる状況については, 以下に示す通りである.
1. 種類が多すぎてクラスにまとめられない場合
    - 扱うオブジェクトの種類があまりにも多すぎて, 1つ1つを別のクラスにしていたら, ソースファイルを多数作成する必要が生じてしまう場合
1. クラスからのインスタンス生成が難しい場合
    - 生成させたいインスタンスが複雑な過程を経て作られるものであり, クラスから作り上げることがとても難しい場合
        - 例えば, グラフィックエディタなどでユーザがマウスの操作によって作り上げた図形を表すインスタンスについて考えた場合, ユーザの操作で作成されるインスタンスを, プログラミングによって作るのは困難である
        - ユーザの操作で作られたインスタンスと同じものを再び作りたい場合には, 今作ったインスタンスを一旦保存しておき, 作りたい時にそれをコピーする
1. フレームワークと生成するインスタンスを分けたい場合
    - インスタンスを生成する時のフレームワークを, 特定のクラスに依存しないように作りたい場合
    - クラス名を指定してインスタンスを作るのではなく, 前もって「雛型」となるインスタンスを登録しておき, その登録したインスタンスをコピーすることでインスタンスを生成する
    - サンプルプログラムでは, インスタンスのコピー(`clone`)を行う部分を`framework`パッケージに閉じ込めている
    - `Manager`クラスの`create`メソッドには, クラス名の代わりに`"strong message"`や`"slash box"`という文字列をインスタンス生成のための名前として与えている
    - これは, Javaが備えているインスタンス生成の機構である`new Something()`という形式をより汎用にし, クラス名の束縛からフレームワークを分離していると言える

# サンプルプログラム
サンプルプログラムは, 文字列を枠線で囲って表示したり, 下線を引いて表示したりするものである.

以下に登場するクラスとインターフェースの一覧を示す

| パッケージ | 名前 | 解説 |
| --- | --- | --- |
| framework | Product | 抽象メソッド`use`と`createClone`が宣言されているインターフェース |
| framework | Manager | `createClone`を使ってインスタンスを複製するクラス |
| 無名 | MessageBox | 文字列を枠線で囲って表示するクラス. `use`と`createClone`を実装している |
| 無名 | UnderlinePen | 文字列に下線を引いて表示するクラス. `use`と`createClone`を実装している |
| 無名 | Main | 動作テスト用のクラス |

## 備考
- `Product`インターフェースは複製を可能にするためのものである
    - このインターフェースは`java.lang.Clonable`インターフェースが継承している
        - このインターフェースを実装しているクラスのインスタンスは, `clone`メソッドを使って自動的に複製を行うことができるようになる
    - `use`メソッドの実装はサブクラスに任せる形となっている
    - `createClone`メソッドは, インスタンスの複製を行うためのものである
- `Manager`クラスは`Product`インターフェースを利用してインスタンスの複製を行うクラスである
    - `showcase`フィールドは, インスタンスの「名前」と「インスタンス」の対応関係を`java.util.HashMap`として表現したものである
    - `register`メソッドで, 製品の名前と`Product`インターフェースが与えられると, その1組を`showcase`に登録する
        - ここで引数に渡されてくる`Product`型の`proto`は実際のクラスはわからないが, `Product`インターフェースを実装したクラスのインスタンスである.(すなわち, `use`メソッドや`createClone`メソッドを呼ぶことができるインスタンス)
    - `MessageBox`クラスや`UnderlinePen`クラスの名前が一切出てこない→`Product`と`Manager`はそれらのクラスとは独立に修正ができる
    
    - **ソース中にクラスの名前を書くと, それらのクラスの間に密接な関係ができてしまう**
    - 具体的な個々のクラスの名前を書かず, ただ`Product`というインターフェース名だけを使うことで, このインターフェースだけが, `Manager`クラスと他のクラスの掛け橋となっている.
- `MessageBox`クラスでは`Product`インターフェースを実装している(implements).
    - `decochar`フィールドは, 文字列を飾り枠のように囲む文字を表す
    - `use`メソッドは, 与えられた文字列を`decochar`で囲む
    - `createClone`メソッドでは, 自分自身の複製を行う
        - ここで呼び出している`clone`メソッドは, Java言語仕様で規定されており, 自分自身の複製を作成するメソッドである
        - 複製を作成する時, インスタンスが持っているフィールドの値もそのまま新しいインスタンスにコピーされる
        - `clone`メソッドでコピーを行うことができるのは, `java.lang.Cloneable`インターフェースを実装しているクラスだけである
        - もし実装されていなければ, 例外`CloneNotSupportedException`が投げられる(`try..catch`で捕まえておく必要がある)
        - `Product`インターフェースは, `Cloneable`インターフェースを拡張したものであるため, 例外にはならないはずである
        - Javaの`clone`メソッドは, 自分のクラス(及びサブクラス)からしか呼び出すことができないので, 他のクラスからの要請で複製を行う場合は, `createClone`のような別メソッドで`clone`を包んでやる必要がある
- `UnderlinePen`クラスでは, `ulchar`フィールドが下線として用いられる(動作は`MessageBox`クラスとほぼ同じ)
    - `use`メソッドま, 与えられた文字列を二重引用符でくくりながら, 文字列の部分に下線を引く
- `Main`クラスでは, 以下の手順で処理が行われる
    1. `Manager`のインスタンスを作成
    1. `Manager`のインスタンスに対して, `UnderlinePen`インスタンスと`MessageBox`インスタンスを登録

# 登場人物
- `Prototype`(原型)
    - `Prototype`役は, インスタンスをコピー(複製)して新しいインスタンスを作るためのメソッドを定める
    - サンプルプログラムでは, `Product`インターフェースがこの役を務めた
- `ConcretePrototype`(具体的な原型)
    - `ConcretePrototype`役は, インスタンスをコピーして新しいインスタンスを作るメソッドを実際に実装する
    - サンプルプログラムでは, `MessageBox`クラスや`UnderlinePen`クラスがこの役を務めた
- `Client`(利用者)
    - `Client`役は, インスタンスをコピーするメソッドを利用して, 新しいインスタンスを作る
    - サンプルプログラムでは, `Manager`クラスがこの役を務めた

# パターンを使う意義
## クラス名は束縛なのか
1. ソースコード中に利用するクラス名が書かれている
1. そのクラスと切り離して再利用ができなくなってしまう
1. オブジェクト指向プログラミングの目標の1つである **「部品としての再利用」が不可能となってしまう！**
1. **手元にソースファイル(.java)が無くても(クラスファイル(.class)だけでも)そのクラスを再利用できるか, がポイント**
1. **部品として独立させなければならないクラスの名前がソース中に書かれていることが問題**
    - もちろん, 密に結合してなければならないクラスの名前がソース中に書かれることに問題はない

# 補足
## `clone`メソッドと`java.lang.Cloneable`インターフェース
### Java言語のclone
Java言語では, インスタンスのコピーを行う機構として`clone`メソッドが用意されている. まだ途中〜

## 練習問題の解答
### 6-1
`MessageBox`クラスと`UnderlinPen`クラスにて同じ動作をする`createClone`メソッドを共有できるようにするには, `Product`インターフェースをクラスに変更して, その中で`createClone`メソッドを実行できるようにすれば良い.

### 6-2
`java.lang.Object`クラスではインターフェースは実装されていない. もしされていたら, どのクラスのインスタンスで`clone`メソッドを呼び出しても, `CloneNotSupportException`が投げられなくなってしまう.

# 関連しているパターン
- Flyweightパターン(第20章)
- Mementoパターン(第18章)
- Compositeパターン(第11章)
- Decoratorパターン(第12章)
- Commandパターン(第22章)